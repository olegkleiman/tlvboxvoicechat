<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />        
        <meta charset="UTF-8" />

        <title>TLV Box</title>

        <link rel="stylesheet" href="./tlvbox.css">

        <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>

    </head>
    <body>
        <div class="player-container">
            <dotlottie-player
                id="lottiePlayer"
                src="https://lottie.host/c0622812-ac4e-4a2f-8678-0f4165553f2f/NAFkq6Fe5M.lottie"
                background="transparent"
                speed="1"
                style="width: 300px; height: 300px"
                loop
                autoplay>

            </dotlottie-player>
        </div>

        <div class="state-container">
            <div id="state_lbl"></div>
        </div>

        <div id="ticker-container">
            <div id="ticker"></div>
        </div>

        <button onclick="onStopAnimation()">Start Speaking</button>
        <button onclick="startAnimation()">Your turn</button>

        <script>

            const text = "Hello, this is a my answer shown in typewriter effect!";
            const player = document.getElementById("lottiePlayer");
            const ticker = document.getElementById('ticker');

            function onStopAnimation() { // User start speaking

                const message = "I'm listening";
                document.getElementById("state_lbl").innerHTML = message;

                player.stop();
                typewriter.innerText = ""
            }

            function startAnimation() { 

                const message = "I'm speaking";
                document.getElementById("state_lbl").innerHTML = message;

                player.play();

                // Initialie the session with the server.
                // It is used for authentication and parameters(prompt) passing
                fetch('/init', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // TBD: Set authorization header
                    },
                    body: JSON.stringify({
                        userId: "123456789",
                        question: "How does the lunar surface look?"
                    })    
                })

                let position = window.innerWidth;
                let content = '';

                const eventSource = new EventSource("./chat_events");
                eventSource.onmessage = (event) => {
                    content += event.data;
                    ticker.textContent = content;
                }

                eventSource.addEventListener('end', () => {
                    eventSource.close();
                    ticker.textContent = content;
                });
            
                function animate() {
                    position -= 1; // speed (px/frame)
                    ticker.style.left = position + 'px';

                    // Reset position when completely out of view
                    if (ticker.getBoundingClientRect().right < 0) {
                        position = window.innerWidth;
                    }

                    requestAnimationFrame(animate);
                }
                
                animate()
            }


        </script>
    </body>
</html>        